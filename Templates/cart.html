{% extends "base.html" %}
{% load static %}
{% block content %}
<h2>Your Cart</h2>

{% if cart|length == 0 %}
  <p>Your cart is empty.</p>
{% else %}
  <table class="table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th style="width:140px;">Qty</th>
        <th>Line Total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for item in cart %}
      <tr>
        <td>
          {% if item.image %}
            <img src="{{ item.image }}" alt="" style="height:40px;vertical-align:middle;margin-right:8px">
          {% endif %}
          <a href="{{ item.product.get_absolute_url }}">
            {{ item.product.title }}
          </a>
        </td>
        <td>{{ item.price }} ৳</td>
        <td>
          <form action="{% url 'orders:cart_add' item.product.id %}" method="post" style="display:flex;gap:6px">
            {% csrf_token %}
            {{ item.update_quantity_form.quantity }}
            {{ item.update_quantity_form.override }}
            <button type="submit">Update</button>
          </form>
        </td>
        <td>{{ item.line_total }} ৳</td>
        <td>
          <form action="{% url 'orders:cart_remove' item.product.id %}" method="post">
            {% csrf_token %}
            <button type="submit">Remove</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="3" style="text-align:right">Subtotal</th>
        <th>{{ cart.get_subtotal }} ৳</th>
        <th></th>
      </tr>
      <tr>
        <th colspan="3" style="text-align:right">Total</th>
        <th>{{ cart.get_total }} ৳</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

  <div style="display:flex;gap:12px;margin-top:16px">
    <a class="btn" href="{% url 'orders:cart_detail' %}?clear=1"
       onclick="return confirm('Clear cart?');">Clear Cart</a>
    <!-- FIX: Use checkout URL without order.id -->
    <a class="btn btn-primary" href="{% url 'payments:checkout' %}">Proceed to Checkout</a>
  </div>
{% endif %}
{% endblock %}